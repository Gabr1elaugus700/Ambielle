{% extends 'global/base.html' %}
{% load static %}

{% block content %}
<main>
    <!-- Bot√µes de a√ß√£o -->
    <section class="action-buttons">
        <button class="btn-filter" data-bs-toggle="modal" data-bs-target="#filterModal">Filtrar Atividades</button>
        <button class="btn-nova-tarefa" id="btn-criar-tarefa">Nova Tarefa</button>
        <button class="btn-relatorios" id="btn-relatorios">
            <i class="fas fa-chart-bar me-2"></i>Relat√≥rios
        </button>
    </section>
    
<div id="filterModal" class="modal fade modal-padrao modal-tarefas" tabindex="-1" aria-labelledby="filterModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="filterModalLabel">Filtrar Atividades</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
            </div>
            <div class="modal-body">
                <!-- Formul√°rio de Filtro -->
                <form id="filterForm" action="{% url 'workflow:timeline' %}" method="GET">
                    <div class="form">
                        <!-- Filtro por Cliente -->
                        <div class="form-label">
                            <label for="cliente">Cliente:</label>
                            <select id="cliente" name="cliente" class="form-control">
                                <option value="todos" {% if cliente_selecionado == "todos" %}selected{% endif %}>Todos os Clientes</option>
                                {% for cliente in clientes %}
                                    <option value="{{ cliente.id }}" {% if cliente.id|stringformat:"s" == cliente_selecionado %}selected{% endif %}>
                                        {{ cliente.nome }}
                                    </option>
                                {% endfor %}
                            </select>
                        </div>

                        <!-- Filtro por Data -->
                        <div class="form-label">
                            <label for="data_inicial">Data Inicial:</label>
                            <input type="date" id="data_inicial" name="data_inicial" class="form-control" value="{{ data_inicial|default_if_none:'' }}">

                            <label for="data_final">Data Final:</label>
                            <input type="date" id="data_final" name="data_final" class="form-control" value="{{ data_final|default_if_none:'' }}">
                        </div>

                        <!-- Filtro por Status -->
                        <div class="filter-group checkbox-group">
                            <h3>Status</h3>
                            <div class="checkbox-item">
                                <label>
                                    <input type="checkbox" id="selectAllStatus" name="status" value="todos"
                                        {% if 'todos' in status_selecionados %}checked{% endif %}>
                                    Todos
                                </label>
                            </div>
                            {% for status, label in status_choices %}
                            <div class="checkbox-item">
                                <label>
                                    <input type="checkbox" name="status" value="{{ status }}"
                                        {% if status in status_selecionados %}checked{% endif %}>
                                    {{ label }}
                                </label>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
                <button type="submit" form="filterForm" class="btn btn-primary">Aplicar Filtros</button>
            </div>
        </div>
    </div>
</div>

    <!-- Lista de Tarefas -->
    <section>
        <div class="tasks-section">
            <div class="tasks-row">
                {% if tarefas %}
                {% for task in tarefas %}
                <div class="task-card" style="--status-color: {{ task.status_color }};">
                    <div class="task-status-bar"></div>
                    <div class="task-content">
                        <div class="task-header">
                            <div class="task-dateCli">
                                <h3>{{ task.cliente }}</h3>
                                <span class="date">{{ task.status }}</span>
                            </div>
                            <!-- Bot√£o de edi√ß√£o -->
                            <button class="btn-editar" data-id="{{ task.id }}" data-status="{{ task.status }}">
                                ‚úèÔ∏è
                            </button>
                        </div>
                        <div class="info">
                            <p><strong>Prazo Final:</strong> <span class="date">{{ task.prazo_final|date:'d/m/y'}}</span></p>
                            {% if task.valor_total_servico %}
                            <p><strong>Valor Servi√ßo:</strong> R${{ task.valor_total_servico }}</p>
                            {% else %}
                            <p>Valor n√£o informado!</p>
                            {% endif %}
                            <p><strong>Servi√ßo:</strong> {{ task.tipo_servico }}</p>
                            {% if task.observacoes %}
                            <p>{{ task.observacoes }}</p>
                            {% else %}
                            <p>Nenhuma Observa√ß√£o cadastrada.</p>
                            {% endif %}
                        </div>
                    </div>
                </div>
                {% endfor %}
                {% else %}
                <p>Nenhuma tarefa encontrada. Ajuste os filtros e tente novamente.</p>
                {% endif %}
            </div>
        </div>
    </section>

    <!-- Modal de Edi√ß√£o de Tarefa -->
    <div class="modal fade modal-padrao modal-tarefas" id="modal-editar-tarefa" tabindex="-1" aria-labelledby="modalEditarTarefaLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="modalEditarTarefaLabel">Editar Tarefa</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
                </div>
                <div class="modal-body" id="modal-form-content">
                    <!-- O conte√∫do ser√° carregado dinamicamente via AJAX -->
                    <div class="text-center py-3">
                        <div class="spinner-border spinner-border-sm text-primary" role="status"></div>
                        <p class="mt-2">Carregando...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de Cria√ß√£o de Tarefa -->
    <div class="modal fade modal-padrao modal-tarefas" id="modal-criar-tarefa" tabindex="-1" aria-labelledby="modalCriarTarefaLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="modalCriarTarefaLabel">Nova Tarefa</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
                </div>
                <div class="modal-body" id="modal-criar-form-content">
                    <!-- O conte√∫do ser√° carregado dinamicamente via AJAX -->
                    <div class="text-center py-3">
                        <div class="spinner-border spinner-border-sm text-primary" role="status"></div>
                        <p class="mt-2">Carregando...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal para Relat√≥rios -->
    <div class="modal fade" id="relatoriosModal" tabindex="-1" aria-labelledby="relatoriosModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-xl modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title d-flex align-items-center" id="relatoriosModalLabel">
                        <i class="fas fa-chart-bar me-2"></i>
                        Gerar Relat√≥rios
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
                </div>
                
                <div class="modal-body p-4">
                    <!-- Se√ß√£o de Filtros Personalizados -->
                    <div class="mb-5">
                        <div class="d-flex align-items-center mb-4 pb-3 border-bottom">
                            <i class="fas fa-filter text-primary me-3" style="font-size: 1.5rem;"></i>
                            <div>
                                <h5 class="mb-1 text-dark">Relat√≥rio Personalizado</h5>
                                <small class="text-muted">Configure filtros para gerar relat√≥rios espec√≠ficos</small>
                            </div>
                        </div>
                        
                        <form id="formRelatorios">
                            <div class="row">
                                <div class="col-lg-6">
                                    <div class="mb-3">
                                        <label for="tipoRelatorio" class="form-label fw-bold">
                                            <i class="fas fa-list me-1"></i>Tipo de Relat√≥rio *
                                        </label>
                                        <select id="tipoRelatorio" class="form-select" required>
                                            <option value="">-- Selecione um tipo --</option>
                                            <option value="tarefas">üìä Tarefas</option>
                                            <option value="clientes">üë• Clientes</option>
                                            <option value="clientes_servicos">üîó Clientes x Servi√ßos</option>
                                            <option value="clientes_servicos_valores">üí∞ Clientes x Servi√ßos x Valores</option>
                                            <option value="clientes_suporte">üõ†Ô∏è Clientes x Suporte</option>
                                            <option value="demandas_por_cliente">üìà Demandas por Cliente</option>
                                        </select>
                                        <div class="form-text">Escolha o tipo de relat√≥rio que deseja gerar</div>
                                    </div>
                                    
                                    <div class="mb-3">
                                        <label for="filtroCliente" class="form-label fw-bold">
                                            <i class="fas fa-building me-1"></i>Cliente
                                        </label>
                                        <input type="text" id="filtroCliente" class="form-control" 
                                               placeholder="Digite o nome do cliente" 
                                               autocomplete="off">
                                        <div class="form-text">Filtro opcional por nome do cliente</div>
                                    </div>
                                    
                                    <div class="mb-3">
                                        <label for="filtroStatus" class="form-label fw-bold">
                                            <i class="fas fa-tasks me-1"></i>Status
                                        </label>
                                        <select id="filtroStatus" class="form-select">
                                            <option value="">-- Todos os status --</option>
                                            <option value="Iniciado">üü° Iniciado</option>
                                            <option value="Coleta De Informa√ß√µes">üîµ Coleta de Informa√ß√µes</option>
                                            <option value="Execucao">üü¢ Execu√ß√£o</option>
                                            <option value="Aprova√ß√£o Cliente">üü† Aprova√ß√£o Cliente</option>
                                            <option value="Conclu√≠do">‚úÖ Conclu√≠do</option>
                                            <option value="Encerrado">‚ö´ Encerrado</option>
                                            <option value="Protocolado">üî¥ Protocolado</option>
                                        </select>
                                    </div>
                                </div>
                                
                                <div class="col-lg-6">
                                    <div class="mb-3">
                                        <label for="filtroServico" class="form-label fw-bold">
                                            <i class="fas fa-cogs me-1"></i>Tipo de Servi√ßo
                                        </label>
                                        <input type="text" id="filtroServico" class="form-control" 
                                               placeholder="Digite o tipo de servi√ßo" 
                                               autocomplete="off">
                                        <div class="form-text">Filtro opcional por tipo de servi√ßo</div>
                                    </div>
                                    
                                    <div class="mb-3">
                                        <label for="filtroDataInicial" class="form-label fw-bold">
                                            <i class="fas fa-calendar-alt me-1"></i>Data Inicial
                                        </label>
                                        <input type="date" id="filtroDataInicial" class="form-control">
                                        <div class="form-text">Data de in√≠cio do per√≠odo</div>
                                    </div>
                                    
                                    <div class="mb-3">
                                        <label for="filtroDataFinal" class="form-label fw-bold">
                                            <i class="fas fa-calendar-check me-1"></i>Data Final
                                        </label>
                                        <input type="date" id="filtroDataFinal" class="form-control">
                                        <div class="form-text">Data final do per√≠odo</div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Bot√µes de Exporta√ß√£o -->
                            <div class="border-top pt-3 mt-3">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div class="text-muted">
                                        <i class="fas fa-info-circle me-1"></i>
                                        <small>Selecione o tipo de relat√≥rio para habilitar a exporta√ß√£o</small>
                                    </div>
                                    <div class="btn-group" role="group" aria-label="Bot√µes de exporta√ß√£o">
                                        <button id="exportarPdf" class="btn btn-danger" type="button" disabled>
                                            <i class="fas fa-file-pdf me-2"></i>Exportar PDF
                                        </button>
                                        <button id="exportarXlsx" class="btn btn-success" type="button" disabled>
                                            <i class="fas fa-file-excel me-2"></i>Exportar XLSX
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </form>
                    </div>
                    
                    <!-- Se√ß√£o de Relat√≥rios Predefinidos -->
                    <div class="mt-5 pt-4 border-top">
                        <div class="d-flex align-items-center mb-4 pb-3 border-bottom">
                            <i class="fas fa-download text-primary me-3" style="font-size: 1.5rem;"></i>
                            <div>
                                <h5 class="mb-1 text-dark">Relat√≥rios Predefinidos</h5>
                                <small class="text-muted">Baixe relat√≥rios completos sem filtros personalizados</small>
                            </div>
                        </div>
                        
                        <div class="row g-3">
                            <div class="col-md-6">
                                <div class="card h-100 border-0 shadow-sm">
                                    <div class="card-body text-center">
                                        <i class="fas fa-tasks fa-2x text-info mb-2"></i>
                                        <h6 class="card-title">Todas as Tarefas</h6>
                                        <p class="card-text text-muted small">Lista completa de todas as tarefas</p>
                                        <div class="btn-group w-100" role="group">
                                            <a href="{% url 'workflow:exportar_xlsx' 'tarefas' %}" 
                                               class="btn btn-outline-success btn-sm">
                                                <i class="fas fa-file-excel me-1"></i>XLSX
                                            </a>
                                            <a href="{% url 'workflow:exportar_pdf' 'tarefas' %}" 
                                               class="btn btn-outline-danger btn-sm">
                                                <i class="fas fa-file-pdf me-1"></i>PDF
                                            </a>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="col-md-6">
                                <div class="card h-100 border-0 shadow-sm">
                                    <div class="card-body text-center">
                                        <i class="fas fa-users fa-2x text-primary mb-2"></i>
                                        <h6 class="card-title">Clientes</h6>
                                        <p class="card-text text-muted small">Lista completa de clientes cadastrados</p>
                                        <div class="btn-group w-100" role="group">
                                            <a href="{% url 'workflow:exportar_xlsx' 'clientes' %}" 
                                               class="btn btn-outline-success btn-sm">
                                                <i class="fas fa-file-excel me-1"></i>XLSX
                                            </a>
                                            <a href="{% url 'workflow:exportar_pdf' 'clientes' %}" 
                                               class="btn btn-outline-danger btn-sm">
                                                <i class="fas fa-file-pdf me-1"></i>PDF
                                            </a>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="col-md-6">
                                <div class="card h-100 border-0 shadow-sm">
                                    <div class="card-body text-center">
                                        <i class="fas fa-handshake fa-2x text-info mb-2"></i>
                                        <h6 class="card-title">Clientes x Servi√ßos</h6>
                                        <p class="card-text text-muted small">Relacionamento clientes e servi√ßos</p>
                                        <div class="btn-group w-100" role="group">
                                            <a href="{% url 'workflow:exportar_xlsx' 'clientes_servicos' %}" 
                                               class="btn btn-outline-success btn-sm">
                                                <i class="fas fa-file-excel me-1"></i>XLSX
                                            </a>
                                            <a href="{% url 'workflow:exportar_pdf' 'clientes_servicos' %}" 
                                               class="btn btn-outline-danger btn-sm">
                                                <i class="fas fa-file-pdf me-1"></i>PDF
                                            </a>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="col-md-6">
                                <div class="card h-100 border-0 shadow-sm">
                                    <div class="card-body text-center">
                                        <i class="fas fa-dollar-sign fa-2x text-success mb-2"></i>
                                        <h6 class="card-title">Clientes x Servi√ßos x Valores</h6>
                                        <p class="card-text text-muted small">Relat√≥rio financeiro completo</p>
                                        <div class="btn-group w-100" role="group">
                                            <a href="{% url 'workflow:exportar_xlsx' 'clientes_servicos_valores' %}" 
                                               class="btn btn-outline-success btn-sm">
                                                <i class="fas fa-file-excel me-1"></i>XLSX
                                            </a>
                                            <a href="{% url 'workflow:exportar_pdf' 'clientes_servicos_valores' %}" 
                                               class="btn btn-outline-danger btn-sm">
                                                <i class="fas fa-file-pdf me-1"></i>PDF
                                            </a>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="col-md-6">
                                <div class="card h-100 border-0 shadow-sm">
                                    <div class="card-body text-center">
                                        <i class="fas fa-headset fa-2x text-warning mb-2"></i>
                                        <h6 class="card-title">Clientes x Suporte</h6>
                                        <p class="card-text text-muted small">Hist√≥rico de atendimentos</p>
                                        <div class="btn-group w-100" role="group">
                                            <a href="{% url 'workflow:exportar_xlsx' 'clientes_suporte' %}" 
                                               class="btn btn-outline-success btn-sm">
                                                <i class="fas fa-file-excel me-1"></i>XLSX
                                            </a>
                                            <a href="{% url 'workflow:exportar_pdf' 'clientes_suporte' %}" 
                                               class="btn btn-outline-danger btn-sm">
                                                <i class="fas fa-file-pdf me-1"></i>PDF
                                            </a>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="col-md-6">
                                <div class="card h-100 border-0 shadow-sm">
                                    <div class="card-body text-center">
                                        <i class="fas fa-chart-line fa-2x text-primary mb-2"></i>
                                        <h6 class="card-title">Demandas por Cliente</h6>
                                        <p class="card-text text-muted small">An√°lise de demandas por cliente</p>
                                        <div class="btn-group" role="group">
                                            <a href="{% url 'workflow:exportar_xlsx' 'demandas_por_cliente' %}" 
                                               class="btn btn-outline-success btn-sm">
                                                <i class="fas fa-file-excel me-1"></i>XLSX
                                            </a>
                                            <a href="{% url 'workflow:exportar_pdf' 'demandas_por_cliente' %}" 
                                               class="btn btn-outline-danger btn-sm">
                                                <i class="fas fa-file-pdf me-1"></i>PDF
                                            </a>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</main>

<!-- Scripts -->
<script>
    // Inicializa√ß√£o do Modal de Filtro
    document.addEventListener('DOMContentLoaded', function () {
        console.log('DOM carregado - iniciando eventos');
        
        // Inicializar modal de edi√ß√£o de tarefa usando o padr√£o
        const modalEditarTarefa = new ModalPadrao('modal-editar-tarefa', {
            titleCreate: 'Nova Tarefa',
            titleEdit: 'Editar Tarefa',
            saveErrorMessage: 'Erro ao salvar tarefa'
        });

        // Inicializar modal de cria√ß√£o de tarefa
        const modalCriarTarefa = new ModalPadrao('modal-criar-tarefa', {
            titleCreate: 'Nova Tarefa',
            titleEdit: 'Nova Tarefa',
            saveErrorMessage: 'Erro ao criar tarefa'
        });

        // Configurar bot√£o de criar tarefa
        const btnCriarTarefa = document.getElementById('btn-criar-tarefa');
        if (btnCriarTarefa) {
            btnCriarTarefa.addEventListener('click', function () {
                console.log('Criando nova tarefa');
                modalCriarTarefa.carregarFormulario(
                    '{% url "workflow:createTarefa" %}', 
                    'Nova Tarefa'
                );
            });
        }

        // Configurar bot√£o de relat√≥rios
        const btnRelatorios = document.getElementById('btn-relatorios');
        if (btnRelatorios) {
            btnRelatorios.addEventListener('click', function () {
                console.log('Abrindo modal de relat√≥rios');
                openRelatoriosModal();
            });
        }

        // Garantir que os bot√µes de fechar do modal de edi√ß√£o funcionem
        document.addEventListener('click', function(e) {
            if (e.target.matches('#modal-editar-tarefa .btn-close') || 
                e.target.matches('#modal-editar-tarefa [data-bs-dismiss="modal"]')) {
                const modal = bootstrap.Modal.getInstance(document.getElementById('modal-editar-tarefa'));
                if (modal) {
                    modal.hide();
                }
            }
        });

        // Configurar bot√µes de editar tarefa
        document.querySelectorAll('.btn-editar').forEach(button => {
            button.addEventListener('click', function () {
                const tarefaId = this.getAttribute('data-id');
                console.log('Editando tarefa ID:', tarefaId);
                
                // Carregar formul√°rio de edi√ß√£o
                modalEditarTarefa.carregarFormulario(
                    `/tarefa/${tarefaId}/carregar-formulario/`, 
                    'Editar Tarefa'
                );
            });
        });

        // Fun√ß√µes para o modal de relat√≥rios
        function openRelatoriosModal() {
            const modal = new bootstrap.Modal(document.getElementById('relatoriosModal'));
            modal.show();
            resetReportForm();
        }

        function resetReportForm() {
            const form = document.getElementById('formRelatorios');
            if (form) {
                form.reset();
            }
            
            // Reset validation states
            const inputs = form?.querySelectorAll('.is-invalid');
            inputs?.forEach(input => {
                input.classList.remove('is-invalid');
            });
            
            // Remove feedback messages
            const feedbacks = form?.querySelectorAll('.invalid-feedback');
            feedbacks?.forEach(feedback => feedback.remove());
            
            // Reset export buttons
            toggleExportButtons();
        }

        function toggleExportButtons() {
            const tipoRelatorio = document.getElementById('tipoRelatorio');
            const btnPdf = document.getElementById('exportarPdf');
            const btnXlsx = document.getElementById('exportarXlsx');
            
            const hasSelection = tipoRelatorio && tipoRelatorio.value;
            
            if (btnPdf) {
                btnPdf.disabled = !hasSelection;
                btnPdf.classList.toggle('btn-danger', hasSelection);
                btnPdf.classList.toggle('btn-outline-danger', !hasSelection);
            }
            
            if (btnXlsx) {
                btnXlsx.disabled = !hasSelection;
                btnXlsx.classList.toggle('btn-success', hasSelection);
                btnXlsx.classList.toggle('btn-outline-success', !hasSelection);
            }
        }

        function validateDateRange() {
            const dataInicial = document.getElementById('filtroDataInicial');
            const dataFinal = document.getElementById('filtroDataFinal');
            
            if (!dataInicial || !dataFinal) return true;
            
            const inicial = new Date(dataInicial.value);
            const final = new Date(dataFinal.value);
            
            // Remove previous validation classes
            dataInicial.classList.remove('is-invalid');
            dataFinal.classList.remove('is-invalid');
            
            // Remove existing feedback
            const existingFeedback = dataFinal.parentNode.querySelector('.invalid-feedback');
            if (existingFeedback) {
                existingFeedback.remove();
            }
            
            if (dataInicial.value && dataFinal.value && inicial > final) {
                dataFinal.classList.add('is-invalid');
                
                const feedback = document.createElement('div');
                feedback.className = 'invalid-feedback';
                feedback.textContent = 'A data final deve ser posterior √† data inicial';
                dataFinal.parentNode.appendChild(feedback);
                
                return false;
            }
            
            return true;
        }

        function exportReport(formato) {
            const tipo = document.getElementById('tipoRelatorio').value;
            
            if (!tipo) {
                alert('Por favor, selecione um tipo de relat√≥rio');
                return;
            }

            // Validate date range before export
            if (!validateDateRange()) {
                alert('Por favor, corrija os erros de valida√ß√£o antes de exportar');
                return;
            }

            const params = new URLSearchParams();
            const filters = {
                cliente: document.getElementById('filtroCliente').value?.trim(),
                status: document.getElementById('filtroStatus').value,
                tipo_servico: document.getElementById('filtroServico').value?.trim(),
                data_inicial: document.getElementById('filtroDataInicial').value,
                data_final: document.getElementById('filtroDataFinal').value
            };

            // Only add non-empty filters
            Object.entries(filters).forEach(([key, value]) => {
                if (value) params.append(key, value);
            });

            const url = `/exportar-${formato}/${tipo}/?${params.toString()}`;
            
            // Open in new tab
            const newWindow = window.open(url, '_blank');
            
            if (!newWindow) {
                alert('Pop-up bloqueado. Por favor, permita pop-ups para este site.');
            } else {
                alert(`Gerando relat√≥rio ${formato.toUpperCase()}...`);
            }
        }

        // Event listeners para o modal de relat√≥rios
        const tipoRelatorio = document.getElementById('tipoRelatorio');
        if (tipoRelatorio) {
            tipoRelatorio.addEventListener('change', toggleExportButtons);
        }

        const dataInicial = document.getElementById('filtroDataInicial');
        const dataFinal = document.getElementById('filtroDataFinal');
        
        if (dataInicial) {
            dataInicial.addEventListener('change', validateDateRange);
        }
        if (dataFinal) {
            dataFinal.addEventListener('change', validateDateRange);
        }

        const btnPdf = document.getElementById('exportarPdf');
        const btnXlsx = document.getElementById('exportarXlsx');
        
        if (btnPdf) btnPdf.addEventListener('click', () => exportReport('pdf'));
        if (btnXlsx) btnXlsx.addEventListener('click', () => exportReport('xlsx'));
    });

    // Fun√ß√£o global para excluir tarefa
    function excluirTarefa(tarefaId) {
        console.log('Fun√ß√£o excluirTarefa chamada com ID:', tarefaId);
        
        if (confirm('Tem certeza que deseja excluir esta tarefa?')) {
            console.log('Confirma√ß√£o aceita, iniciando exclus√£o...');
            
            const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]');
            if (!csrfToken) {
                console.error('Token CSRF n√£o encontrado');
                alert('Erro: Token de seguran√ßa n√£o encontrado');
                return;
            }
            
            fetch(`/ambielle/tarefa/${tarefaId}/delete/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': csrfToken.value
                }
            })
            .then(response => {
                console.log('Response status exclus√£o:', response.status);
                if (!response.ok) {
                    throw new Error(`Erro HTTP! Status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                console.log('Response data exclus√£o:', data);
                if (data.success) {
                    alert('Tarefa exclu√≠da com sucesso!');
                    location.reload();
                } else {
                    console.error('Erro do servidor na exclus√£o:', data.error);
                    alert('Erro: ' + (data.error || 'Erro desconhecido'));
                }
            })
            .catch(error => {
                console.error('Erro no fetch de exclus√£o:', error);
                alert('Erro na comunica√ß√£o com o servidor: ' + error.message);
            });
        } else {
            console.log('Exclus√£o cancelada pelo usu√°rio');
        }
    }
</script>
{% endblock %}