{% extends 'global/base.html' %}

{% block content %}
<main>
    <!-- Botão para abrir o modal de filtro -->
    <section>
        <button class="open-modal-btn">Filtrar Atividades</button>
    </section>
    
<div id="filterModal" class="modal fade" tabindex="-1" aria-labelledby="filterModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="filterModalLabel">Filtrar Atividades</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <!-- Formulário de Filtro -->
                <form id="filterForm" action="{% url 'workflow:get_tarefas_filtradas' %}" method="GET">
                    <div class="form">
                        <!-- Filtro por Cliente -->
                        <div class="form-label">
                            <label for="cliente">Cliente:</label>
                            <select id="cliente" name="cliente" class="form-control">
                                <option value="todos" {% if cliente_selecionado == "todos" %}selected{% endif %}>Todos os Clientes</option>
                                {% for cliente in clientes %}
                                    <option value="{{ cliente.id }}" {% if cliente.id|stringformat:"s" == cliente_selecionado %}selected{% endif %}>
                                        {{ cliente.nome }}
                                    </option>
                                {% endfor %}
                            </select>
                        </div>

                        <!-- Filtro por Data -->
                        <div class="form-label">
                            <label for="data_inicial">Data Inicial:</label>
                            <input type="date" id="data_inicial" name="data_inicial" class="form-control" value="{{ data_inicial|default_if_none:'' }}">

                            <label for="data_final">Data Final:</label>
                            <input type="date" id="data_final" name="data_final" class="form-control" value="{{ data_final|default_if_none:'' }}">
                        </div>

                        <!-- Filtro por Status -->
                        <div class="filter-group checkbox-group">
                            <h3>Status</h3>
                            <div class="checkbox-item">
                                <label>
                                    <input type="checkbox" id="selectAllStatus" name="status" value="todos"
                                        {% if 'todos' in status_selecionados %}checked{% endif %}>
                                    Todos
                                </label>
                            </div>
                            {% for status, label in status_choices %}
                            <div class="checkbox-item">
                                <label>
                                    <input type="checkbox" name="status" value="{{ status }}"
                                        {% if status in status_selecionados %}checked{% endif %}>
                                    {{ label }}
                                </label>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
                <button type="submit" form="filterForm" class="btn btn-primary">Aplicar Filtros</button>
            </div>
        </div>
    </div>
</div>

    <!-- Lista de Tarefas -->
    <section>
        <div class="tasks-section">
            <div class="tasks-row">
                {% if tarefas %}
                {% for task in tarefas %}
                <div class="task-card" style="--status-color: {{ task.status_color }};">
                    <div class="task-status-bar"></div>
                    <div class="task-content">
                        <div class="task-header">
                            <div class="task-dateCli">
                                <h3>{{ task.cliente }}</h3>
                                <span class="date">{{ task.status }}</span>
                            </div>
                            <!-- Botão de edição -->
                            <button class="btn-editar" data-id="{{ task.id }}" data-status="{{ task.status }}">
                                ✏️
                            </button>
                        </div>
                        <div class="info">
                            <p><strong>Prazo Final:</strong> <span class="date">{{ task.prazo_final|date:'d/m/y'}}</span></p>
                            {% if task.valor_total_servico %}
                            <p><strong>Valor Serviço:</strong> R${{ task.valor_total_servico }}</p>
                            {% else %}
                            <p>Valor não informado!</p>
                            {% endif %}
                            <p><strong>Serviço:</strong> {{ task.tipo_servico }}</p>
                            {% if task.observacoes %}
                            <p>{{ task.observacoes }}</p>
                            {% else %}
                            <p>Nenhuma Observação cadastrada.</p>
                            {% endif %}
                        </div>
                    </div>
                </div>
                {% endfor %}
                {% else %}
                <p>Nenhuma tarefa encontrada. Ajuste os filtros e tente novamente.</p>
                {% endif %}
            </div>
        </div>
    </section>

    <!-- Modal de Edição de Tarefa -->
    <div id="modal-editar-tarefa" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Editar Tarefa</h2>
                <span class="close">&times;</span>
            </div>
            <div class="modal-body">
                <!-- O conteúdo será carregado dinamicamente via AJAX -->
                <div id="modal-loading">
                    <p>Carregando...</p>
                </div>
            </div>
        </div>
    </div>
</main>

<!-- Scripts -->
<script>
    // Inicialização do Modal de Filtro
    document.addEventListener('DOMContentLoaded', function () {
        console.log('DOM carregado - iniciando eventos');
        
        // Inicialização do modal de filtro
        var filterModal = new bootstrap.Modal(document.getElementById('filterModal'));
        var openModalBtn = document.querySelector('.open-modal-btn');
        var closeModalBtn = document.querySelector('.modal .btn-close');
        var closeFooterBtn = document.querySelector('.modal-footer .btn-secondary');
    
        // Abrir modal de filtro
        openModalBtn.addEventListener('click', function () {
            filterModal.show();
        });
    
        // Fechar modal de filtro
        closeModalBtn.addEventListener('click', function () {
            filterModal.hide();
        });
    
        // Fechar modal de filtro ao clicar no botão "Fechar" do modal-footer
        closeFooterBtn.addEventListener('click', function () {
            filterModal.hide();
        });
    
        // Inicialização do modal de edição de tarefa
        var modalEditar = document.getElementById('modal-editar-tarefa');
        var closeModalEditar = document.querySelector('#modal-editar-tarefa .close');
        var modalEditarBody = document.querySelector('#modal-editar-tarefa .modal-body');
        
        console.log('Modal editar encontrado:', modalEditar);
        console.log('Botões editar encontrados:', document.querySelectorAll('.btn-editar').length);
    
        // Abrir modal de edição de tarefa e carregar formulário via AJAX
        document.querySelectorAll('.btn-editar').forEach(button => {
            button.addEventListener('click', function () {
                const tarefaId = this.getAttribute('data-id');
                console.log('Tentando carregar tarefa ID:', tarefaId);
    
                // Mostra loading
                modalEditarBody.innerHTML = '<div id="modal-loading"><p>Carregando...</p></div>';
                modalEditar.style.display = 'block';
    
                // Carrega o formulário de edição via AJAX
                fetch(`/tarefa/${tarefaId}/carregar-formulario/`)
                    .then(response => {
                        console.log('Response status carregar formulário:', response.status);
                        if (!response.ok) {
                            throw new Error(`Erro HTTP! Status: ${response.status}`);
                        }
                        return response.text();
                    })
                    .then(html => {
                        console.log('HTML carregado com sucesso');
                        modalEditarBody.innerHTML = html;
    
                        // Procura pelo formulário carregado
                        const formEditarTarefa = modalEditarBody.querySelector('#form-tarefa');
                        if (!formEditarTarefa) {
                            throw new Error('Formulário #form-tarefa não encontrado');
                        }
                        
                        console.log('Formulário encontrado:', formEditarTarefa);
                        
                        // Define a ação do formulário
                        formEditarTarefa.action = `/ambielle/tarefa/${tarefaId}/editar/`;
                        console.log('Action definida:', formEditarTarefa.action);

                        // Adiciona o evento de submit ao formulário carregado
                        formEditarTarefa.addEventListener('submit', function (event) {
                            event.preventDefault();
                            console.log('Formulário sendo enviado...');

                            const formData = new FormData(formEditarTarefa);
                            
                            // Log para debug
                            console.log('Dados do formulário:');
                            for (const [key, value] of formData.entries()) {
                                console.log(`${key}: ${value}`);
                            }

                            fetch(formEditarTarefa.action, {
                                method: 'POST',
                                body: formData,
                                headers: {
                                    'X-CSRFToken': formData.get('csrfmiddlewaretoken')
                                }
                            })
                            .then(response => {
                                console.log('Response status edição:', response.status);
                                if (!response.ok) {
                                    throw new Error(`Erro HTTP! Status: ${response.status}`);
                                }
                                return response.json();
                            })
                            .then(data => {
                                console.log('Response data:', data);
                                if (data.success) {
                                    alert('Tarefa atualizada com sucesso!');
                                    modalEditar.style.display = 'none';
                                    location.reload();
                                } else {
                                    console.error('Erro do servidor:', data.error);
                                    alert('Erro: ' + JSON.stringify(data.error));
                                }
                            })
                            .catch(error => {
                                console.error('Erro no fetch de edição:', error);
                                alert('Erro na comunicação com o servidor: ' + error.message);
                            });
                        });

                        // Adiciona eventos para botões de fechar
                        const closeButtons = modalEditarBody.querySelectorAll('.btn-secondary, .close-modal');
                        closeButtons.forEach(btn => {
                            btn.addEventListener('click', function() {
                                modalEditar.style.display = 'none';
                            });
                        });

                        // Adiciona evento para botão de exclusão
                        const btnExcluir = modalEditarBody.querySelector('.btn-excluir');
                        if (btnExcluir) {
                            btnExcluir.addEventListener('click', function() {
                                const tarefaId = this.getAttribute('data-tarefa-id');
                                excluirTarefa(tarefaId);
                            });
                        }
                    })
                    .catch(error => {
                        console.error('Erro ao carregar formulário:', error);
                        modalEditarBody.innerHTML = `<div class="alert alert-danger">Erro ao carregar o formulário: ${error.message}</div>`;
                    });
            });
        });
    
        // Fechar modal de edição de tarefa
        closeModalEditar.addEventListener('click', function () {
            modalEditar.style.display = 'none';
        });
    
        // Fechar modal de edição ao clicar fora dele
        window.addEventListener('click', function (event) {
            if (event.target === modalEditar) {
                modalEditar.style.display = 'none';
            }
        });
    
        // Fechar modal com tecla ESC
        document.addEventListener('keydown', function(event) {
            if (event.key === 'Escape' && modalEditar.style.display === 'block') {
                modalEditar.style.display = 'none';
            }
        });
    });

    // Função global para excluir tarefa
    function excluirTarefa(tarefaId) {
        console.log('Função excluirTarefa chamada com ID:', tarefaId);
        
        if (confirm('Tem certeza que deseja excluir esta tarefa?')) {
            console.log('Confirmação aceita, iniciando exclusão...');
            
            const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]');
            if (!csrfToken) {
                console.error('Token CSRF não encontrado');
                alert('Erro: Token de segurança não encontrado');
                return;
            }
            
            fetch(`/ambielle/tarefa/${tarefaId}/delete/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': csrfToken.value
                }
            })
            .then(response => {
                console.log('Response status exclusão:', response.status);
                if (!response.ok) {
                    throw new Error(`Erro HTTP! Status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                console.log('Response data exclusão:', data);
                if (data.success) {
                    alert('Tarefa excluída com sucesso!');
                    document.getElementById('modal-editar-tarefa').style.display = 'none';
                    location.reload();
                } else {
                    console.error('Erro do servidor na exclusão:', data.error);
                    alert('Erro: ' + (data.error || 'Erro desconhecido'));
                }
            })
            .catch(error => {
                console.error('Erro no fetch de exclusão:', error);
                alert('Erro na comunicação com o servidor: ' + error.message);
            });
        } else {
            console.log('Exclusão cancelada pelo usuário');
        }
    }
</script>
{% endblock %}