{% extends 'global/base.html' %}

{% block content %}
<div class="containerForm">
  <div class="tela-form">
    <div class="title-form">
      <h1>Atividades Realizadas por Cliente:</h1>
    </div>
    <form id="filterForm" action="{% url 'workflow:get_tarefas_filtradas' %}" method="GET" enctype="multipart/form-data">
      <div class="form">
        <!-- Filtro por Cliente -->
        <div class="form-label">
          <label for="cliente">Cliente:</label>
          <select id="cliente" name="cliente" class="form-control">
            <option value="" {% if not cliente_selecionado %}selected{% endif %}>Selecione um cliente</option>
            {% for cliente in clientes %}
            <option value="{{ cliente.id }}" {% if cliente.id|stringformat:"s" == cliente_selecionado %}selected{% endif %}>
              {{ cliente.nome }}
            </option>
            {% endfor %}
          </select>
        </div>

        <!-- Filtro por Data -->
        <div class="form-label">
          <label for="data_inicial">Data Inicial:</label>
          <input type="date" id="data_inicial" name="data_inicial" class="form-control" value="{{ data_inicial|default_if_none:'' }}">

          <label for="data_final">Data Final:</label>
          <input type="date" id="data_final" name="data_final" class="form-control" value="{{ data_final|default_if_none:'' }}">
        </div>

        <!-- Filtro por Status -->
        {% comment %} <div class="form-label"> {% endcomment %}
          <div class="filter-group checkbox-group">
            <h3>Status</h3>
            <div class="checkbox-item">
                <label>
                    <input type="checkbox" id="selectAllStatus" name="status" value="todos"
                           {% if 'todos' in status_selecionados %}checked{% endif %}>
                    Todos
                </label>
            </div>
            {% for status, label in status_choices %}
            <div class="checkbox-item">
                <label>
                    <input type="checkbox" name="status" value="{{ status }}"
                           {% if status in status_selecionados %}checked{% endif %}>
                    {{ label }}
                </label>
            </div>
            {% endfor %}
          </div>
        </div>

        <!-- Botões de Aplicar e Limpar Filtros -->
        <div class="btn">
          <button type="submit" class="btn-form">Aplicar Filtros</button>
          <button type="reset" class="btn-form" onclick="window.location.href='{% url 'workflow:get_tarefas_filtradas' %}'">Limpar Filtros</button>
        </div>
      </div>
    </form>
  </div>
</div>

<div class="tasks-section">
  <div class="tasks-row">
    {% if tarefas %}
      {% for task in tarefas %}
      <div class="task-card">
        <div class="task-header">
          <div class="task-dateCli">
            <h3>{{ task.cliente }}</h3>
            <div class="date">{{ task.prazo_final|date:'d/m/y' }}</div>
          </div>
          <div class="status">
            <svg xmlns="http://www.w3.org/2000/svg" width="30" height="30" viewBox="0 0 18 18" fill="none">
              <circle cx="9" cy="9" r="8.5" fill="{{ task.status_color }}" stroke="black" />
            </svg>
          </div>
        </div>
        <div class="info">
          <p><strong>Status:</strong> {{ task.status }}</p>
          <p><strong>Serviço:</strong> {{ task.tipo_servico }}</p>
          {% if task.observacoes %}
          <p>{{ task.observacoes }}</p>
          {% else %}
          <p>Nenhuma Observação cadastrada.</p>
          {% endif %}
        </div>
      </div>
      {% endfor %}
    {% else %}
    <p>Nenhuma tarefa encontrada. Ajuste os filtros e tente novamente.</p>
    {% endif %}
  </div>
</div>

<script>
  document.addEventListener("DOMContentLoaded", function () {
    const selectAllCheckbox = document.getElementById("selectAllStatus");
    const statusCheckboxes = document.querySelectorAll('input[name="status"]');

    selectAllCheckbox.addEventListener("change", function () {
      const isChecked = this.checked;
      statusCheckboxes.forEach(function (checkbox) {
        checkbox.checked = isChecked;
      });
    });

    statusCheckboxes.forEach(function (checkbox) {
      checkbox.addEventListener("change", function () {
        if (!this.checked) {
          selectAllCheckbox.checked = false;
        } else {
          const allChecked = Array.from(statusCheckboxes).every(cb => cb.checked);
          selectAllCheckbox.checked = allChecked;
        }
      });
    });
  });
</script>
{% endblock %}
