{% extends 'global/base.html' %}
{% load static %}

{% block content %}
<main>
    <!-- Botões de ação -->
    <section class="action-buttons">
        <button class="btn-filter" data-bs-toggle="modal" data-bs-target="#filterModal">Filtrar Atividades</button>
        <button class="btn-nova-tarefa" id="btn-criar-tarefa">Nova Tarefa</button>
    </section>
    
<div id="filterModal" class="modal fade modal-padrao modal-tarefas" tabindex="-1" aria-labelledby="filterModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="filterModalLabel">Filtrar Atividades</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
            </div>
            <div class="modal-body">
                <!-- Formulário de Filtro -->
                <form id="filterForm" action="{% url 'workflow:timeline' %}" method="GET">
                    <div class="form">
                        <!-- Filtro por Cliente -->
                        <div class="form-label">
                            <label for="cliente">Cliente:</label>
                            <select id="cliente" name="cliente" class="form-control">
                                <option value="todos" {% if cliente_selecionado == "todos" %}selected{% endif %}>Todos os Clientes</option>
                                {% for cliente in clientes %}
                                    <option value="{{ cliente.id }}" {% if cliente.id|stringformat:"s" == cliente_selecionado %}selected{% endif %}>
                                        {{ cliente.nome }}
                                    </option>
                                {% endfor %}
                            </select>
                        </div>

                        <!-- Filtro por Data -->
                        <div class="form-label">
                            <label for="data_inicial">Data Inicial:</label>
                            <input type="date" id="data_inicial" name="data_inicial" class="form-control" value="{{ data_inicial|default_if_none:'' }}">

                            <label for="data_final">Data Final:</label>
                            <input type="date" id="data_final" name="data_final" class="form-control" value="{{ data_final|default_if_none:'' }}">
                        </div>

                        <!-- Filtro por Status -->
                        <div class="filter-group checkbox-group">
                            <h3>Status</h3>
                            <div class="checkbox-item">
                                <label>
                                    <input type="checkbox" id="selectAllStatus" name="status" value="todos"
                                        {% if 'todos' in status_selecionados %}checked{% endif %}>
                                    Todos
                                </label>
                            </div>
                            {% for status, label in status_choices %}
                            <div class="checkbox-item">
                                <label>
                                    <input type="checkbox" name="status" value="{{ status }}"
                                        {% if status in status_selecionados %}checked{% endif %}>
                                    {{ label }}
                                </label>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
                <button type="submit" form="filterForm" class="btn btn-primary">Aplicar Filtros</button>
            </div>
        </div>
    </div>
</div>

    <!-- Lista de Tarefas -->
    <section>
        <div class="tasks-section">
            <div class="tasks-row">
                {% if tarefas %}
                {% for task in tarefas %}
                <div class="task-card" style="--status-color: {{ task.status_color }};">
                    <div class="task-status-bar"></div>
                    <div class="task-content">
                        <div class="task-header">
                            <div class="task-dateCli">
                                <h3>{{ task.cliente }}</h3>
                                <span class="date">{{ task.status }}</span>
                            </div>
                            <!-- Botão de edição -->
                            <button class="btn-editar" data-id="{{ task.id }}" data-status="{{ task.status }}">
                                ✏️
                            </button>
                        </div>
                        <div class="info">
                            <p><strong>Prazo Final:</strong> <span class="date">{{ task.prazo_final|date:'d/m/y'}}</span></p>
                            {% if task.valor_total_servico %}
                            <p><strong>Valor Serviço:</strong> R${{ task.valor_total_servico }}</p>
                            {% else %}
                            <p>Valor não informado!</p>
                            {% endif %}
                            <p><strong>Serviço:</strong> {{ task.tipo_servico }}</p>
                            {% if task.observacoes %}
                            <p>{{ task.observacoes }}</p>
                            {% else %}
                            <p>Nenhuma Observação cadastrada.</p>
                            {% endif %}
                        </div>
                    </div>
                </div>
                {% endfor %}
                {% else %}
                <p>Nenhuma tarefa encontrada. Ajuste os filtros e tente novamente.</p>
                {% endif %}
            </div>
        </div>
    </section>

    <!-- Modal de Edição de Tarefa -->
    <div class="modal fade modal-padrao modal-tarefas" id="modal-editar-tarefa" tabindex="-1" aria-labelledby="modalEditarTarefaLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="modalEditarTarefaLabel">Editar Tarefa</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
                </div>
                <div class="modal-body" id="modal-form-content">
                    <!-- O conteúdo será carregado dinamicamente via AJAX -->
                    <div class="text-center py-3">
                        <div class="spinner-border spinner-border-sm text-primary" role="status"></div>
                        <p class="mt-2">Carregando...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de Criação de Tarefa -->
    <div class="modal fade modal-padrao modal-tarefas" id="modal-criar-tarefa" tabindex="-1" aria-labelledby="modalCriarTarefaLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="modalCriarTarefaLabel">Nova Tarefa</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
                </div>
                <div class="modal-body" id="modal-criar-form-content">
                    <!-- O conteúdo será carregado dinamicamente via AJAX -->
                    <div class="text-center py-3">
                        <div class="spinner-border spinner-border-sm text-primary" role="status"></div>
                        <p class="mt-2">Carregando...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</main>

<!-- Scripts -->
<script>
    // Inicialização do Modal de Filtro
    document.addEventListener('DOMContentLoaded', function () {
        console.log('DOM carregado - iniciando eventos');
        
        // Inicializar modal de edição de tarefa usando o padrão
        const modalEditarTarefa = new ModalPadrao('modal-editar-tarefa', {
            titleCreate: 'Nova Tarefa',
            titleEdit: 'Editar Tarefa',
            saveErrorMessage: 'Erro ao salvar tarefa'
        });

        // Inicializar modal de criação de tarefa
        const modalCriarTarefa = new ModalPadrao('modal-criar-tarefa', {
            titleCreate: 'Nova Tarefa',
            titleEdit: 'Nova Tarefa',
            saveErrorMessage: 'Erro ao criar tarefa'
        });

        // Configurar botão de criar tarefa
        const btnCriarTarefa = document.getElementById('btn-criar-tarefa');
        if (btnCriarTarefa) {
            btnCriarTarefa.addEventListener('click', function () {
                console.log('Criando nova tarefa');
                modalCriarTarefa.carregarFormulario(
                    '{% url "workflow:createTarefa" %}', 
                    'Nova Tarefa'
                );
            });
        }

        // Garantir que os botões de fechar do modal de edição funcionem
        document.addEventListener('click', function(e) {
            if (e.target.matches('#modal-editar-tarefa .btn-close') || 
                e.target.matches('#modal-editar-tarefa [data-bs-dismiss="modal"]')) {
                const modal = bootstrap.Modal.getInstance(document.getElementById('modal-editar-tarefa'));
                if (modal) {
                    modal.hide();
                }
            }
        });

        // Configurar botões de editar tarefa
        document.querySelectorAll('.btn-editar').forEach(button => {
            button.addEventListener('click', function () {
                const tarefaId = this.getAttribute('data-id');
                console.log('Editando tarefa ID:', tarefaId);
                
                // Carregar formulário de edição
                modalEditarTarefa.carregarFormulario(
                    `/tarefa/${tarefaId}/carregar-formulario/`, 
                    'Editar Tarefa'
                );
            });
        });
    });

    // Função global para excluir tarefa
    function excluirTarefa(tarefaId) {
        console.log('Função excluirTarefa chamada com ID:', tarefaId);
        
        if (confirm('Tem certeza que deseja excluir esta tarefa?')) {
            console.log('Confirmação aceita, iniciando exclusão...');
            
            const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]');
            if (!csrfToken) {
                console.error('Token CSRF não encontrado');
                alert('Erro: Token de segurança não encontrado');
                return;
            }
            
            fetch(`/ambielle/tarefa/${tarefaId}/delete/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': csrfToken.value
                }
            })
            .then(response => {
                console.log('Response status exclusão:', response.status);
                if (!response.ok) {
                    throw new Error(`Erro HTTP! Status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                console.log('Response data exclusão:', data);
                if (data.success) {
                    alert('Tarefa excluída com sucesso!');
                    location.reload();
                } else {
                    console.error('Erro do servidor na exclusão:', data.error);
                    alert('Erro: ' + (data.error || 'Erro desconhecido'));
                }
            })
            .catch(error => {
                console.error('Erro no fetch de exclusão:', error);
                alert('Erro na comunicação com o servidor: ' + error.message);
            });
        } else {
            console.log('Exclusão cancelada pelo usuário');
        }
    }
</script>
{% endblock %}